import boto3

def lambda_handler(event, context):
    ec2 = boto3.client('ec2')
    
    # The 'event' tells us which Security Group (SG) is non-compliant
    # We extract the ID from the AWS Config / Security Hub finding
    sg_id = event['detail']['resourceId'] 
    
    print(f"CRITICAL: Port 22 is open on {sg_id}. Closing now...")

    try:
        # The 'Fix': Remove the ingress rule for Port 22 from '0.0.0.0/0'
        ec2.revoke_security_group_ingress(
            GroupId=sg_id,
            IpProtocol='tcp',
            FromPort=22,
            ToPort=22,
            CidrIp='0.0.0.0/0'
        )
        return "SUCCESS: Public SSH access removed."
    except Exception as e:
        print(f"Error: {str(e)}")
        return "FAILED: Could not close port."
